// PKGPATH: gno.land/r/crossrealm_test
package crossrealm_test

import (
	"std"

	"gno.land/r/demo/tests"
	"gno.land/r/demo/tests/unsaferealm"
	"gno.land/r/demo/tests/fake20"
)

func main() {
	println("crossrealm caller :", std.GetCaller(), "balance:", unsaferealm.BalanceOf(std.GetCaller()))
	println("unsaferealm caller:", unsaferealm.GetCaller(), "balance:", unsaferealm.BalanceOf(unsaferealm.GetCaller()))
	println("fake20 caller     :", fake20.GetCaller(), "balance:", unsaferealm.BalanceOf(fake20.GetCaller()))
	println("======================")

	addr := std.GetCaller()
	// println("balance:", unsaferealm.BalanceOf(addr))

	// Test to exploit from the Do function steal money from unsaferealm treasury
	unsaferealm.Do(func() {
		println("transfering 1.", std.GetCaller())
		unsaferealm.Transfer(addr, 100000)
	})

	println("balance:", unsaferealm.BalanceOf(addr))
	println("======================")

	// Test to exploit from the Do function steal money from unsaferealm treasury
	unsaferealm.Do(func() {
		println("transfering 2.", std.GetCaller())
		fake20.Transfer(addr, 100000)
		unsaferealm.Do(func() {
			fake20.Transfer(addr, 100000)
		})
	})

	println("======================")
	println("crossrealm caller :", std.GetCaller(), "balance:", unsaferealm.BalanceOf(std.GetCaller()))
	println("unsaferealm caller:", unsaferealm.GetCaller(), "balance:", unsaferealm.BalanceOf(unsaferealm.GetCaller()))
	println("fake20 caller     :", fake20.GetCaller(), "balance:", unsaferealm.BalanceOf(fake20.GetCaller()))
}

// Output:
// crossrealm caller : g1wymu47drhr0kuq2098m792lytgtj2nyx77yrsm balance: 0
// unsaferealm caller: g1lpnflsxpr84dsqkznw85yd5wdzenkj89vsptmf balance: 10000000000
// fake20 caller     : g1zjzuzhywuxrk3cdvm7ma33vu4x2xyunxhzslu9 balance: 0
// ======================
// transfering 1. g1lpnflsxpr84dsqkznw85yd5wdzenkj89vsptmf
// transfering 100000 from: g1vla5mffzum6060t99u4xhm8mnhgxr0sz4k574p to: g1wymu47drhr0kuq2098m792lytgtj2nyx77yrsm
// balance: 0
// ======================
// transfering 2. g1lpnflsxpr84dsqkznw85yd5wdzenkj89vsptmf
// transfering 100000 from: g1vla5mffzum6060t99u4xhm8mnhgxr0sz4k574p to: g1wymu47drhr0kuq2098m792lytgtj2nyx77yrsm
// transfering 100000 from: g1vla5mffzum6060t99u4xhm8mnhgxr0sz4k574p to: g1wymu47drhr0kuq2098m792lytgtj2nyx77yrsm
// ======================
// crossrealm caller : g1wymu47drhr0kuq2098m792lytgtj2nyx77yrsm balance: 0
// unsaferealm caller: g1lpnflsxpr84dsqkznw85yd5wdzenkj89vsptmf balance: 10000000000
// fake20 caller     : g1zjzuzhywuxrk3cdvm7ma33vu4x2xyunxhzslu9 balance: 0
